{
  "metadata": {
    "version": "1.0",
    "created_at": "2026-02-18T03:07:48.783259+00:00",
    "updated_at": "2026-02-18T03:09:48.520070+00:00"
  },
  "stories": [
    {
      "id": "US-001",
      "title": "Add blob_url column to recordings table via SQLite v5 migration",
      "feature_area": "Data Migration",
      "priority": "Must",
      "role": "mobile app",
      "want": "a v5 SQLite migration that adds a blob_url TEXT column (DEFAULT NULL) to the recordings table and retroactively repairs existing synced recordings by moving any file_path value that starts with http:// or https:// into the new blob_url column and setting file_path to NULL",
      "benefit": "the schema cleanly separates local filesystem paths from remote blob storage URLs, and recordings synced under the old behavior immediately become exportable once the app updates",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "the app is starting up on a device with schema version 4",
          "when": "the migration runner processes v5",
          "then": "it executes ALTER TABLE recordings ADD COLUMN blob_url TEXT DEFAULT NULL without error"
        },
        {
          "id": "AC-2",
          "given": "existing recordings where file_path starts with http:// or https://",
          "when": "the v5 retroactive UPDATE runs",
          "then": "blob_url is set to the former file_path value and file_path is set to NULL"
        },
        {
          "id": "AC-3",
          "given": "existing recordings where file_path starts with file:/// or is NULL",
          "when": "the v5 retroactive UPDATE runs",
          "then": "those rows are not modified"
        },
        {
          "id": "AC-4",
          "given": "the migration file exists at apps/mobile/src/data/migrations/v5_add_blob_url.ts",
          "when": "database.ts is inspected",
          "then": "the v5 migration is registered and will run on app startup before any user interaction"
        }
      ],
      "notes": "",
      "dependencies": [],
      "status": "Ready",
      "created_at": "2026-02-18T03:07:48.783259+00:00",
      "updated_at": "2026-02-18T03:09:06.076501+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:07:48.783259+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.143473+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:06.076501+00:00"
        }
      ]
    },
    {
      "id": "US-002",
      "title": "Add blobUrl field to Recording domain type",
      "feature_area": "Domain Model",
      "priority": "Must",
      "role": "developer",
      "want": "an optional blobUrl field added to the Recording interface and NewRecordingData interface in packages/domain/src/models/Recording.ts",
      "benefit": "the TypeScript type system distinguishes between local filesystem paths and remote blob URLs throughout the entire codebase, preventing the kind of conflation that caused the original bug",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "the Recording interface in packages/domain/src/models/Recording.ts",
          "when": "it is inspected",
          "then": "it contains an optional blobUrl?: string field alongside the existing filePath field"
        },
        {
          "id": "AC-2",
          "given": "the NewRecordingData interface",
          "when": "it is inspected",
          "then": "it also contains an optional blobUrl?: string field"
        },
        {
          "id": "AC-3",
          "given": "the domain package change is applied",
          "when": "npm run type-check:all is executed",
          "then": "TypeScript strict mode compilation succeeds with no type errors"
        }
      ],
      "notes": "",
      "dependencies": [
        "US-001"
      ],
      "status": "Ready",
      "created_at": "2026-02-18T03:07:57.348233+00:00",
      "updated_at": "2026-02-18T03:09:12.274995+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:07:57.348233+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.275928+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:12.274995+00:00"
        }
      ]
    },
    {
      "id": "US-003",
      "title": "Update RecordingRepository to map and persist blob_url column",
      "feature_area": "Data Access",
      "priority": "Must",
      "role": "mobile app",
      "want": "the RecordingRepository to read blob_url from the database into the blobUrl domain field, and to support writing blobUrl in both create() and update() operations",
      "benefit": "all layers above the repository can store and retrieve the blob URL without direct SQL knowledge, and updates to blobUrl are persisted correctly alongside other recording fields",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "the RecordingRow interface in RecordingRepository.ts",
          "when": "it is inspected",
          "then": "it includes a blob_url: string | null field"
        },
        {
          "id": "AC-2",
          "given": "a row is read from the database with blob_url = NULL",
          "when": "mapRowToRecording() processes it",
          "then": "the returned Recording has blobUrl as undefined"
        },
        {
          "id": "AC-3",
          "given": "a row is read from the database with a blob_url value",
          "when": "mapRowToRecording() processes it",
          "then": "the returned Recording has blobUrl set to that string value"
        },
        {
          "id": "AC-4",
          "given": "recordingRepo.update() is called with { blobUrl: someUrl }",
          "when": "the dynamic field builder runs",
          "then": "the SQL includes blob_url = ? with the correct value"
        },
        {
          "id": "AC-5",
          "given": "recordingRepo.create() is called with a NewRecordingData that includes blobUrl",
          "when": "the INSERT is executed",
          "then": "the blob_url column is populated correctly"
        }
      ],
      "notes": "",
      "dependencies": [
        "US-001",
        "US-002"
      ],
      "status": "Ready",
      "created_at": "2026-02-18T03:08:06.938864+00:00",
      "updated_at": "2026-02-18T03:09:20.258794+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:08:06.938864+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.408573+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:20.258794+00:00"
        }
      ]
    },
    {
      "id": "US-004",
      "title": "Fix SyncService to store blob URL separately and clear local file path",
      "feature_area": "Sync",
      "priority": "Must",
      "role": "researcher",
      "want": "the sync service to store the uploaded blob URL in the new blobUrl field instead of overwriting filePath, delete the local CSV file after successful upload, and set filePath to null",
      "benefit": "device storage is reclaimed after sync while the blob URL is preserved for future exports, and the two concerns of local storage and remote storage are no longer conflated in a single field",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "SyncService.syncRecordings() completes a successful file upload",
          "when": "it processes the uploadResponse.fileUrl",
          "then": "it calls recordingRepo.update(recording.id, { blobUrl: uploadResponse.fileUrl }) to store the blob URL"
        },
        {
          "id": "AC-2",
          "given": "the blob URL has been stored",
          "when": "the local file is processed",
          "then": "the local CSV file is deleted from the device filesystem"
        },
        {
          "id": "AC-3",
          "given": "the local file has been deleted",
          "when": "the filePath is updated",
          "then": "recordingRepo.update(recording.id, { filePath: null }) is called, clearing the local path"
        },
        {
          "id": "AC-4",
          "given": "the old single update({ filePath: uploadResponse.fileUrl }) pattern",
          "when": "SyncService.ts is inspected",
          "then": "it no longer exists"
        },
        {
          "id": "AC-5",
          "given": "a file upload fails",
          "when": "error handling runs",
          "then": "neither blobUrl nor filePath is modified for that recording"
        },
        {
          "id": "AC-6",
          "given": "the sync cycle runs after this change",
          "when": "sessions, annotations, and other entities are processed",
          "then": "they continue to sync correctly with no change in behavior"
        }
      ],
      "notes": "",
      "dependencies": [
        "US-003"
      ],
      "status": "Ready",
      "created_at": "2026-02-18T03:08:16.628551+00:00",
      "updated_at": "2026-02-18T03:09:29.610283+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:08:16.628551+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.544007+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:29.610283+00:00"
        }
      ]
    },
    {
      "id": "US-005",
      "title": "Fix HistoryScreen export to fetch CSV from blob URL for synced recordings",
      "feature_area": "Export",
      "priority": "Must",
      "role": "researcher",
      "want": "the ZIP export on HistoryScreen to download CSV content from the blob URL when the local file is absent, producing a valid ZIP with actual sEMG data for synced recordings",
      "benefit": "exported ZIPs always contain real signal data regardless of whether the recording was synced, eliminating the silent corruption that makes exported data unusable for analysis",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "a recording where rec.filePath is set and FileSystem.getInfoAsync() returns exists: true",
          "when": "handleExportSession() runs",
          "then": "the CSV content is read from local disk (unchanged behavior)"
        },
        {
          "id": "AC-2",
          "given": "a recording where rec.blobUrl is set and the local file is absent",
          "when": "handleExportSession() runs",
          "then": "FileSystem.downloadAsync() downloads the CSV to a temp file, the content is read, and the temp file is deleted"
        },
        {
          "id": "AC-3",
          "given": "a recording where neither filePath nor blobUrl is set",
          "when": "handleExportSession() runs",
          "then": "the recording entry in the ZIP contains the text: # No recording data available"
        },
        {
          "id": "AC-4",
          "given": "a fully synced session (all recordings have blobUrl, no local files)",
          "when": "the user taps Export ZIP",
          "then": "the resulting ZIP contains actual CSV data rows, not placeholder text"
        },
        {
          "id": "AC-5",
          "given": "csvExport.ts",
          "when": "it is inspected after this change",
          "then": "exportSessionAsZip() is unchanged"
        }
      ],
      "notes": "",
      "dependencies": [
        "US-003",
        "US-004"
      ],
      "status": "Ready",
      "created_at": "2026-02-18T03:08:27.154414+00:00",
      "updated_at": "2026-02-18T03:09:39.312256+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:08:27.154414+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.670654+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:39.312256+00:00"
        }
      ]
    },
    {
      "id": "US-006",
      "title": "Handle offline export gracefully when blob URL is unreachable",
      "feature_area": "Export",
      "priority": "Must",
      "role": "researcher",
      "want": "the ZIP export to produce an informative per-recording placeholder when a blob URL fetch fails due to network unavailability, instead of crashing or silently producing an empty entry",
      "benefit": "researchers using the app offline understand that synced recordings require network access to export, rather than receiving a corrupt ZIP with no explanation",
      "acceptance_criteria": [
        {
          "id": "AC-1",
          "given": "FileSystem.downloadAsync() throws or returns an error for a blob URL",
          "when": "handleExportSession() handles the failure",
          "then": "the recording entry in the ZIP contains: # Recording data is on server (offline)"
        },
        {
          "id": "AC-2",
          "given": "one or more blob URL fetches failed during export",
          "when": "the ZIP is complete",
          "then": "a user-facing alert is shown listing the failed recordings and explaining that network access is required"
        },
        {
          "id": "AC-3",
          "given": "a mix of local and blob URL recordings in the same session",
          "when": "one blob fetch fails during export",
          "then": "recordings with local files are still included in the ZIP successfully"
        },
        {
          "id": "AC-4",
          "given": "blob URL returns an HTTP error status code (e.g. 404, 500)",
          "when": "the export handler processes the response",
          "then": "it is treated as a failure and the offline placeholder is used"
        },
        {
          "id": "AC-5",
          "given": "the export runs while the device is offline",
          "when": "the network request times out",
          "then": "the app does not crash and the user receives the informative alert"
        }
      ],
      "notes": "",
      "dependencies": [
        "US-005"
      ],
      "status": "Ready",
      "created_at": "2026-02-18T03:08:36.844448+00:00",
      "updated_at": "2026-02-18T03:09:48.520070+00:00",
      "created_by": "po",
      "history": [
        {
          "action": "created",
          "by": "po",
          "at": "2026-02-18T03:08:36.844448+00:00"
        },
        {
          "action": "status_change",
          "by": "po",
          "from": "Draft",
          "to": "Ready",
          "at": "2026-02-18T03:08:42.844004+00:00"
        },
        {
          "action": "edited",
          "by": "po",
          "changes": [
            "acceptance_criteria"
          ],
          "at": "2026-02-18T03:09:48.520070+00:00"
        }
      ]
    }
  ],
  "questions": []
}